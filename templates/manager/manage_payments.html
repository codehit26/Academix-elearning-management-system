{% extends 'base.html' %}
{% load static %}

{% block title %}Manage Payments - E-Learning Platform{% endblock %}

{% block content %}
<div class="container-fluid py-4">

    <div class="row align-items-center mb-4">
        <div class="col">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-1 text-dark">Payment Management</h1>
                    <p class="text-muted mb-0">Manage and update student payment details</p>
                </div>
                <a href="{% url 'manager_dashboard' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
                </a>
            </div>
        </div>
    </div>


    <div class="row mb-5">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="card-title text-muted text-uppercase small fw-bold">Total Payments</h6>
                            <h2 class="text-primary mb-0">{{ payments.count }}</h2>
                            <span class="text-muted small">All transactions</span>
                        </div>
                        <div class="flex-shrink-0">
                            <div class="bg-primary bg-opacity-10 rounded-3 p-3">
                                <i class="fas fa-credit-card text-primary fa-lg"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="card-title text-muted text-uppercase small fw-bold">Completed</h6>
                            <h2 class="text-success mb-0">{{ completed_payments.count }}</h2>
                            <span class="text-muted small">Successful payments</span>
                        </div>
                        <div class="flex-shrink-0">
                            <div class="bg-success bg-opacity-10 rounded-3 p-3">
                                <i class="fas fa-check-circle text-success fa-lg"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="card-title text-muted text-uppercase small fw-bold">Pending</h6>
                            <h2 class="text-warning mb-0">{{ pending_payments.count }}</h2>
                            <span class="text-muted small">Awaiting confirmation</span>
                        </div>
                        <div class="flex-shrink-0">
                            <div class="bg-warning bg-opacity-10 rounded-3 p-3">
                                <i class="fas fa-clock text-warning fa-lg"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="card-title text-muted text-uppercase small fw-bold">Failed</h6>
                            <h2 class="text-danger mb-0">{{ failed_payments.count }}</h2>
                            <span class="text-muted small">Requires attention</span>
                        </div>
                        <div class="flex-shrink-0">
                            <div class="bg-danger bg-opacity-10 rounded-3 p-3">
                                <i class="fas fa-exclamation-triangle text-danger fa-lg"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <div class="card border-0 shadow-lg">
        <div class="card-header bg-white py-4 border-bottom">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h3 class="card-title mb-1 text-dark">
                        <i class="fas fa-list-alt text-primary me-2"></i>All Payments
                    </h3>
                    <p class="text-muted mb-0">Payment transactions across the platform</p>
                </div>
                <span class="badge bg-primary fs-6 px-3 py-2">{{ payments.count }} payments</span>
            </div>
        </div>
        <div class="card-body p-0">
            {% if payments %}
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th class="ps-4 py-3 fw-semibold text-dark">Payment ID</th>
                                <th class="py-3 fw-semibold text-dark">Student</th>
                                <th class="py-3 fw-semibold text-dark">Course</th>
                                <th class="py-3 fw-semibold text-dark">Amount</th>
                                <th class="py-3 fw-semibold text-dark">Status</th>
                                <th class="py-3 fw-semibold text-dark">Date</th>
                                <th class="text-center py-3 fw-semibold text-dark">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for payment in payments %}
                            <tr class="border-bottom">
                                <td class="ps-4 py-3">
                                    <strong>{{ payment.payment_id|default:"N/A" }}</strong>
                                </td>
                                <td class="py-3">
                                    <div class="d-flex align-items-center">
                                        <div class="flex-shrink-0">
                                            <div class="bg-info bg-opacity-10 rounded-circle p-2 me-3">
                                                <i class="fas fa-user text-info"></i>
                                            </div>
                                        </div>
                                        <div class="flex-grow-1">
                                            <strong class="d-block">{{ payment.student.get_full_name|default:payment.student.username }}</strong>
                                            <small class="text-muted">{{ payment.student.email }}</small>
                                        </div>
                                    </div>
                                </td>
                                <td class="py-3">
                                    <strong class="d-block">{{ payment.course.title }}</strong>
                                    <small class="text-muted">{{ payment.course.category|default:"General" }}</small>
                                </td>
                                <td class="py-3">
                                    <strong class="text-success">${{ payment.amount }}</strong>
                                </td>
                                <td class="py-3">
                                    <span class="badge
                                        {% if payment.payment_status == 'completed' %}bg-success
                                        {% elif payment.payment_status == 'pending' %}bg-warning
                                        {% elif payment.payment_status == 'failed' %}bg-danger
                                        {% else %}bg-secondary{% endif %}">
                                        {{ payment.payment_status|title }}
                                    </span>
                                </td>
                                <td class="py-3">
                                    <small class="d-block">{{ payment.created_at|date:"M d, Y" }}</small>
                                    <small class="text-muted">{{ payment.created_at|time }}</small>
                                </td>
                                <td class="py-3">
                                    <div class="d-flex justify-content-center gap-2">

                                        <form method="post" class="d-inline">
                                            {% csrf_token %}
                                            <input type="hidden" name="payment_id" value="{{ payment.id }}">
                                            <select name="payment_status" class="form-select form-select-sm" onchange="this.form.submit()">
                                                <option value="pending" {% if payment.payment_status == 'pending' %}selected{% endif %}>Pending</option>
                                                <option value="completed" {% if payment.payment_status == 'completed' %}selected{% endif %}>Completed</option>
                                                <option value="failed" {% if payment.payment_status == 'failed' %}selected{% endif %}>Failed</option>
                                                <option value="refunded" {% if payment.payment_status == 'refunded' %}selected{% endif %}>Refunded</option>
                                            </select>
                                        </form>
                                        <button class="btn btn-outline-info btn-sm"
                                                data-bs-toggle="modal"
                                                data-bs-target="#paymentModal{{ payment.id }}"
                                                title="View Details">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>


                                    <div class="modal fade" id="paymentModal{{ payment.id }}" tabindex="-1">
                                        <div class="modal-dialog">
                                            <div class="modal-content">
                                                <div class="modal-header bg-dark text-white">
                                                    <h5 class="modal-title">Payment Details</h5>
                                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                                </div>
                                                <div class="modal-body">
                                                    <h6>Payment Information</h6>
                                                    <p><strong>Payment ID:</strong> {{ payment.payment_id|default:"Not provided" }}</p>
                                                    <p><strong>Amount:</strong> ${{ payment.amount }}</p>
                                                    <p><strong>Status:</strong>
                                                        <span class="badge
                                                            {% if payment.payment_status == 'completed' %}bg-success
                                                            {% elif payment.payment_status == 'pending' %}bg-warning
                                                            {% elif payment.payment_status == 'failed' %}bg-danger
                                                            {% else %}bg-secondary{% endif %}">
                                                            {{ payment.payment_status|title }}
                                                        </span>
                                                    </p>
                                                    <p><strong>Date:</strong> {{ payment.created_at|date:"F j, Y, g:i a" }}</p>

                                                    <h6 class="mt-3">Student Information</h6>
                                                    <p><strong>Name:</strong> {{ payment.student.get_full_name|default:payment.student.username }}</p>
                                                    <p><strong>Email:</strong> {{ payment.student.email }}</p>
                                                    <p><strong>User Type:</strong> {{ payment.student.get_user_type_display }}</p>

                                                    <h6 class="mt-3">Course Information</h6>
                                                    <p><strong>Course:</strong> {{ payment.course.title }}</p>
                                                    <p><strong>Category:</strong> {{ payment.course.category|default:"General" }}</p>
                                                    <p><strong>Trainer:</strong> {{ payment.course.trainer.get_full_name|default:payment.course.trainer.username|default:"Not assigned" }}</p>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="text-center py-5">
                    <div class="bg-light rounded-circle d-inline-flex p-4 mb-4">
                        <i class="fas fa-credit-card text-muted fa-3x"></i>
                    </div>
                    <h4 class="text-muted mb-3">No Payments Found</h4>
                    <p class="text-muted">There are no payment records in the system yet.</p>
                </div>
            {% endif %}
        </div>
    </div>


    <div class="card mt-4 border-0 shadow-sm">
        <div class="card-header bg-white">
            <h5 class="mb-0 text-dark">
                <i class="fas fa-rocket text-primary me-2"></i>Quick Actions
            </h5>
        </div>
        <div class="card-body">
            <div class="d-flex gap-2 flex-wrap">
                <a href="{% url 'manager_dashboard' %}" class="btn btn-outline-primary">
                    <i class="fas fa-tachometer-alt me-2"></i>Back to Dashboard
                </a>
                <a href="{% url 'manage_courses' %}" class="btn btn-outline-success">
                    <i class="fas fa-book me-2"></i>Manage Courses
                </a>
                <a href="{% url 'manage_trainers' %}" class="btn btn-outline-warning">
                    <i class="fas fa-chalkboard-teacher me-2"></i>Manage Trainers
                </a>
            </div>
        </div>
    </div>
</div>

<style>
.table tbody tr {
    transition: background-color 0.2s ease;
}
.table tbody tr:hover {
    background-color: rgba(0,0,0,0.02);
}
</style>

{% block scripts %}
<script>

    document.addEventListener('DOMContentLoaded', function() {
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[title]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    });
</script>
{% endblock %}
{% endblock %}